{% extends "base.html" %}

{% block title %}Production{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-72px)]">

    <!-- Sidebar -->
    <div class="w-64 bg-white border-r overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-bold text-black">SpindleStock</h2>
        </div>

    <div class="p-4">

    <a href="/stock/"
       class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-colors mb-2
       {% if request.endpoint == 'spindlestock.dashboard' %}
           bg-primary-50 text-primary-600 border-r-4 border-primary-600
       {% else %}
           text-gray-600 hover:bg-gray-50
       {% endif %}">
        <span class="text-xl">üìä</span>
        <span>Dashboard</span>
    </a>

    <a href="/stock/raw"
       class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-colors mb-2
       {% if request.endpoint == 'spindlestock.raw_material' %}
           bg-primary-50 text-primary-600 border-r-4 border-primary-600
       {% else %}
           text-gray-600 hover:bg-gray-50
       {% endif %}">
        <span class="text-xl">üì¶</span>
        <span>Raw Material</span>
    </a>

    <a href="/stock/production"
       class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-colors mb-2
       {% if request.endpoint == 'spindlestock.production' %}
           bg-primary-50 text-primary-600 border-r-4 border-primary-600
       {% else %}
           text-gray-600 hover:bg-gray-50
       {% endif %}">
        <span class="text-xl">üè≠</span>
        <span>Production</span>
    </a>

    <a href="/stock/inventory"
       class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-colors
       {% if request.endpoint == 'spindlestock.inventory' %}
           bg-primary-50 text-primary-600 border-r-4 border-primary-600
       {% else %}
           text-gray-600 hover:bg-gray-50
       {% endif %}">
        <span class="text-xl">üìã</span>
        <span>Stock Balance</span>
    </a>

</div>
    </div>

    <!-- Content -->
    <div class="flex-1 p-6 overflow-y-auto">

        <!-- Flash Toast -->
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div id="toast"
            class="fixed top-20 right-5 z-50 bg-white text-green-600 px-6 py-3 rounded-lg shadow-lg
            opacity-0 translate-y-[-20px] transition-all duration-500">
            üéâ‚úÖ {{ messages[0] }}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Production Entry -->
        <div class="card p-6 mb-6">
            <h4 class="text-lg font-semibold mb-4">
                Production Entry
            </h4>

            <form method="POST" class="space-y-4">

                <div class="grid grid-cols-4 gap-4">

                    <div>
                        <label class="text-sm font-medium">Product Name</label>
                        <input name="product" required
                               class="w-full border rounded-lg px-3 py-2">
                    </div>

                    <div>
                        <label class="text-sm font-medium">Quantity Produced</label>
                        <input type="number" step="0.01" min="0"
                               name="qty_produced" required
                               class="w-full border rounded-lg px-3 py-2">
                    </div>

                    <div>
                        <label class="text-sm font-medium">Unit</label>
                        <select name="produced_unit"
                                class="w-full border rounded-lg px-3 py-2">
                            <option value="kg">kg</option>
                            <option value="ton">ton</option>
                        </select>
                    </div>

                    <div>
                        <label class="text-sm font-medium">Expiry Date</label>
                        <input type="date" name="expiry_date"
                               class="w-full border rounded-lg px-3 py-2">
                    </div>

                </div>

                <div>
                    <h6 class="font-semibold mt-4 mb-2">
                        Raw Materials Used
                    </h6>

                    <div id="materials-container" class="space-y-2"></div>

                    <button type="button"
                            onclick="addMaterialRow()"
                            class="btn-secondary mt-3">
                        + Add Material
                    </button>
                </div>

                <button class="btn-primary mt-4">
                    Save Production
                </button>

            </form>
        </div>

        <!-- Production Records -->
        <div class="card p-6">
            <h5 class="font-semibold mb-4">
                Production Records
            </h5>

            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="border-b bg-gray-50 text-gray-600">
                        <tr>
                            <th class="px-4 py-3 text-left">Product</th>
                            <th class="px-4 py-3 text-left">Produced Qty</th>
                            <th class="px-4 py-3 text-left">Expiry</th>
                            <th class="px-4 py-3 text-left">Date</th>
                        </tr>
                    </thead>

                    <tbody class="divide-y">
                        {% for p in productions %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 font-medium">
                                {{ p.product_name }}
                            </td>
                            <td class="px-4 py-3">
                                {{ p.quantity_produced }}
                            </td>
                            <td class="px-4 py-3">
                                {{ p.expiry_date }}
                            </td>
                            <td class="px-4 py-3">
                                {{ p.date.strftime("%d %b %Y") }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function addMaterialRow() {
    let container = document.getElementById("materials-container");

    let row = document.createElement("div");
    row.className = "grid grid-cols-3 gap-3";

    row.innerHTML = `
        <select class="border rounded-lg px-3 py-2"
                name="material_ids[]">
            {% for m in materials %}
            <option value="{{ m.id }}">
                {{ m.name }} ({{ m.quantity }} {{ m.unit }})
            </option>
            {% endfor %}
        </select>

        <input type="number" step="0.01" min="0"
               name="qty_used[]" required
               placeholder="Quantity Used"
               class="border rounded-lg px-3 py-2">

        <select name="used_unit[]"
                class="border rounded-lg px-3 py-2">
            <option value="kg">kg</option>
            <option value="ton">ton</option>
        </select>
    `;

    container.appendChild(row);
}

addMaterialRow();

/* Toast animation */
const toast = document.getElementById("toast");
if (toast) {
    setTimeout(() => {
        toast.classList.remove("opacity-0", "translate-y-[-20px]");
    }, 100);

    setTimeout(() => {
        toast.classList.add("opacity-0");
    }, 3000);
}
</script>
{% endblock %}